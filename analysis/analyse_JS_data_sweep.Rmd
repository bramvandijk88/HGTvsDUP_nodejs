---
title: "Analyse HGT_vs_DUP JS data"
author: "Bram van Dijk"
date: "12/08/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}

# The code below is not necessary, but can improve graphical quality on certain windows 10 implementations
 trace(grDevices:::png, quote({
   if (missing(type) && missing(antialias)) {
     type <- "cairo-png"
     antialias <- "subpixel"
   }
 }), print = FALSE)

knitr::opts_chunk$set(echo = TRUE)


cols <- rep(c("dodgerblue2","#E31A1C", # red
              "green4",
              "#6A3D9A", # purple
              "#FF7F00", # orange
              "black","steelblue4",
              "skyblue2","#FB9A99", # lt pink
              "palegreen2",
              "#CAB2D6", # lt purple
              "#FDBF6F", # lt orange
              "gray70", "khaki2",
              "maroon","orchid1","deeppink1","blue1","gold1",
              "darkturquoise","green1","yellow4","yellow3",
              "darkorange4","brown"),20)


library(ggplot2)
library(dplyr)
library(viridis)
library(tidyverse)
library(foreach)
library(doParallel)
library(patchwork)

```


### Analyse data from HGT_vs_DUP (javascript implementation)
There are two types of output. Averages over time, and the raw data. This document plots histograms of the raw data fow now. Below, give the output file generated by the code <seed>_raw.txt, and it plots ... something. 


```{r cars, echo=FALSE}

setwd('D:/Output_sweep'); #<-- Disabled for knitting
avgfiles <- list.files(pattern='*avg.txt')

registerDoParallel(core=detectCores()-1)
all_data <- foreach(i=1:length(avgfiles), .combine=rbind, .packages='dplyr') %dopar%
{
   name = avgfiles[i]
   seed = as.numeric(gsub(".*s(.+)_c.*", "\\1", name))
   cost = as.numeric(gsub(".*_c(.+)_u.*", "\\1", name))
   mu = as.numeric(gsub(".*_u(.+)_avg.*", "\\1", name))
   dat<-read.table(name,sep="",header=T)
   
   gsize_dup <- mean((dat %>% filter(Time>50000))$AvglenDUP)
   gsize_hgt <- mean((dat %>% filter(Time>50000))$AvglenHGT)
   
   data.frame(seed=seed,cost=cost,mu=mu,gsize_dup=gsize_dup,gsize_hgt=gsize_hgt)
}
stopImplicitCluster()

registerDoParallel(core=detectCores()-1)
timedata <- foreach(i=1:length(avgfiles), .combine=rbind, .packages='dplyr') %dopar%
{
   name = avgfiles[i]
   seed = as.numeric(gsub(".*s(.+)_c.*", "\\1", name))
   cost = as.numeric(gsub(".*_c(.+)_u.*", "\\1", name))
   mu = as.numeric(gsub(".*_u(.+)_avg.*", "\\1", name))
   dat<-read.table(name,sep="",header=T)
   
   #gsize_dup <- mean((dat %>% filter(Time>50000))$AvglenDUP)
   #gsize_hgt <- mean((dat %>% filter(Time>50000))$AvglenHGT)
   dat$seed=seed
   dat$cost=cost
   dat$mu=mu
   dat
   #data.frame(seed=seed,cost=cost,mu=mu,gsize_dup=gsize_dup,gsize_hgt=gsize_hgt)
}
stopImplicitCluster()

#rawfile <- "../Output_sweep/s1_c0.1_u0.0125_raw.txt"
#rawdata <- read.table(rawfile,sep=",");
## Renaming the first columns, which are the timepoint and the variable-names and poptypes
#names(rawdata)[1] <- "time"
#names(rawdata)[3] <- "variable"
#names(rawdata)[2] <- "poptype"
## gathering the data into a long-format data frame structured:
## <timepoint,variable,value>
#rawdata <- gather(rawdata, key,value,-c(time,variable,poptype))


#gathereddata <- gather(all_data,variable,value,-c(Time))

```

## Fitness distribution in population at variable points in time:

Here, some distributions are drawn using various plots:

```{r pressure, echo=TRUE}

all_data2 <- all_data %>% filter(!is.na(gsize_hgt) && !is.na(gsize_dup)) %>% group_by(cost,mu) %>% mutate(avgd=mean(gsize_dup,na.rm=T),avgh=mean(gsize_hgt,na.rm=T),avgr=avgd/avgh,stdev=sd(gsize_dup/gsize_hgt,na.rm=T)) %>% ungroup()

signifs <- all_data2 %>% group_by(cost,mu) %>% summarise(sign=wilcox.test(gsize_dup,gsize_hgt)$p.value)

head(all_data2) 
head(signifs)

                                      
all_data2 %>% ggplot(aes(x=as.factor(cost),y=as.factor(mu),fill=avgr)) + geom_tile() + scale_fill_viridis(trans="log",name="DUPsize/HGTsize") +
   geom_text(size=5.5,position = position_nudge(y = 0.1),aes(label=round(avgr,2)),col="black",alpha=1.0,check_overlap = T) +
   geom_text(size=4.5, position = position_nudge(y = -0.2), aes(label=paste("±",round(stdev,2))),col="black",alpha=1.0,check_overlap = T)+
   theme_bw() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + coord_fixed() + xlab("Costs of gene expression") + ylab("Mutation rate") #+ facet_wrap(~seed)

all_data2 %>% filter(seed==2,cost>0.0004,mu>0.0004) %>% ggplot(aes(x=as.factor(cost),y=as.factor(mu))) +
   geom_point(aes(size=avgd*1.1),col="blue",fill="blue",alpha=0.5,pch=21) +geom_point(aes(size=avgh),col="red",pch=19,alpha=0.8) +
   
#   scale_radius(range=c(10,25),trans="identity")+
   scale_size_area(max_size=30,trans="identity")+
scale_color_viridis(trans="pseudo_log",name="DUPsize/HGTsize") +
   geom_text(size=10,data=signifs %>% filter(sign<0.05,cost>0.0004,mu>0.0004),label="*",position = position_nudge(y = -0.1))+
   #geom_text(size=4.5,position = position_nudge(y = -0.2),aes(label=round(avgr,2)),col="black",alpha=1.0,check_overlap = T) +
  # geom_text(size=4.5, position = position_nudge(y = -0.2), aes(label=paste("±",round(stdev,2))),col="black",alpha=1.0,check_overlap = T)+
   theme_bw() + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + coord_fixed() + xlab("Costs of gene expression") + ylab("Mutation rate") 



timedata %>% filter(cost==0.003125,mu==0.003125,seed %in% c(1,3,4,5,10,7)) %>% 
   ggplot(aes(x=Time,y=AvglenDUP)) + 
   geom_line(col="red") +
   geom_line(aes(y=AvglenHGT),col="blue") +
    facet_wrap(~seed)

# rawdata %>% filter(Time %in% seq(0,300000,by=50000)) %>% ggplot(aes(x=exprDUP,y=AvglenDUP)) + geom_point(size=1) + theme_bw() + scale_colour_manual(values=cols) + facet_wrap(~Time)

(p1/p2/p3)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
